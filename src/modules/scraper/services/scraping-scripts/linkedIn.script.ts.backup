/* eslint-disable prettier/prettier */
import puppeteer from 'puppeteer-extra';
import StealthPlugin from 'puppeteer-extra-plugin-stealth';

puppeteer.use(StealthPlugin());
import { ArticleType } from '../../../../models/articles.models';
import { isAllowedLinkedInCompany } from '../scraping-config/target-sources.config';
import * as fs from 'fs';

const env_vars = {
  LINKEDIN_EMAIL: process.env.LINKEDIN_EMAIL || 'TO REPLACE',
  LINKEDIN_PASSWORD: process.env.LINKEDIN_PASSWORD || 'TO REPLACE',
};

const COOKIES_PATH = '/tmp/linkedin-cookies.json';

// Helper function for random delays (makes scraping look more human)
const randomDelay = (min: number, max: number) => {
  return new Promise(resolve => setTimeout(resolve, Math.random() * (max - min) + min));
};

// Save cookies for session persistence
const saveCookies = async (page: any) => {
  try {
    const cookies = await page.cookies();
    fs.writeFileSync(COOKIES_PATH, JSON.stringify(cookies));
    console.log('üíæ Cookies saved for future sessions');
  } catch (error) {
    console.warn('‚ö†Ô∏è  Could not save cookies');
  }
};

// Load cookies to avoid repeated logins
const loadCookies = async (page: any) => {
  try {
    if (fs.existsSync(COOKIES_PATH)) {
      const cookies = JSON.parse(fs.readFileSync(COOKIES_PATH, 'utf8'));
      await page.setCookie(...cookies);
      console.log('üç™ Loaded saved cookies');
      return true;
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è  Could not load cookies');
  }
  return false;
};

//**/ NOTE: "linkedIn POST" SCRAPPING SCRIPT WITH STEALTH
export async function getAllLinkedInArticles(companyName: string) {
  // Validate if company is in approved list
  if (!isAllowedLinkedInCompany(companyName)) {
    console.warn(`‚ö†Ô∏è  LinkedIn company '${companyName}' is not in the approved list. Skipping scraping.`);
    return [];
  }

  console.log(`‚úÖ LinkedIn company '${companyName}' is approved. Starting scraping...`);
  const { browser, page } = await getPuppeteerInstance();

  try {
    // Try to load existing cookies first
    const hasValidSession = await loadCookies(page);

    if (hasValidSession) {
      console.log('üîÑ Attempting to use existing session...');
      await page.goto(`https://www.linkedin.com/company/${companyName}/posts/`, { 
        waitUntil: 'networkidle2',
        timeout: 60000 
      });

      await randomDelay(2000, 4000);

      // Check if we're still logged in
      const isLoggedIn = await page.evaluate(() => {
        return !window.location.href.includes('/login') && 
               !window.location.href.includes('/checkpoint');
      });

      if (!isLoggedIn) {
        console.log('üîê Session expired, logging in again...');
        await performLogin(page, companyName);
      } else {
        console.log('‚úÖ Already logged in, skipping login!');
      }
    } else {
      console.log('üîê No saved session, performing fresh login...');
      await performLogin(page, companyName);
    }

    // Make sure we're on the posts page
    const currentUrl = page.url();
    if (!currentUrl.includes(`/company/${companyName}/posts`)) {
      console.log(`üìç Navigating to company posts: ${companyName}...`);
      await page.goto(`https://www.linkedin.com/company/${companyName}/posts/`, { 
        waitUntil: 'networkidle2',
        timeout: 180000 
      });
      await randomDelay(3000, 5000);
    }

    // Save cookies for next time
    await saveCookies(page);

    console.log('üìú Scrolling to load posts...');
    let prevHeight = 0;
    let scrollAttempts = 0;
    const maxScrollAttempts = 10;

    while (scrollAttempts < maxScrollAttempts) {
      const newHeight = (await page.evaluate('document.documentElement.scrollHeight')) as number;
      if (newHeight === prevHeight) break;
      
      await page.evaluate('window.scrollTo(0, document.documentElement.scrollHeight)');
      
      // Random human-like delay between scrolls
      await randomDelay(2000, 4000);
      
      prevHeight = newHeight;
      scrollAttempts++;

      if (prevHeight > 20000) break;
    }

    console.log(`   Scrolled ${scrollAttempts} times`);

    console.log('üîç Scraping posts...');
    const posts = await page.evaluate(
      (articleType, companyName) => {
        const postElements = document.querySelectorAll('.feed-shared-update-v2');
        return Array.from(postElements).map((post) => {
          const textElement = post.querySelector('.feed-shared-update-v2__description') as HTMLElement;
          const imgElement =
            post.querySelector('img.update-components-article__image') ||
            post.querySelector('img.update-components-image__image');

          const companyImgElement = post.querySelector('img');

          const dateElement = post.querySelector('.update-components-actor__sub-description > span') as HTMLElement;
          return {
            baseUrl: window.location.href,
            type: articleType,
            dateText: dateElement
              ? dateElement.innerText
                  .replace(/\‚Ä¢/g, '')
                  .replace(/\Modifi√©/g, '')
                  .trim()
              : 'N/A',
            originalContent: textElement ? textElement.innerHTML.trim() : 'N/A',
            image: imgElement ? imgElement?.getAttribute('src') : 'N/A',
            metadata: {
              icon: companyImgElement ? companyImgElement?.getAttribute('src') : 'N/A',
              source: companyName,
            },
          };
        });
      },
      ArticleType.LinkedIn,
      companyName,
    );

    console.log(`‚úÖ Successfully scraped ${posts.length} posts`);

    await browser.close();

    return posts;

  } catch (error) {
    console.error('‚ùå LinkedIn scraping failed:', error.message);
    
    // Take screenshot for debugging
    try {
      await page.screenshot({ path: `/tmp/linkedin-error-${Date.now()}.png` });
      console.log('üì∏ Error screenshot saved to /tmp/');
    } catch (screenshotError) {
      console.error('   Could not save screenshot');
    }

    await browser.close();
    throw error;
  }
}

// Separate login function
async function performLogin(page: any, companyName: string) {
  console.log('üìç Navigating to LinkedIn login page...');
  await page.goto('https://www.linkedin.com/login', { waitUntil: 'networkidle2', timeout: 60000 });
  
  await randomDelay(1000, 2000);

  console.log('üîê Entering credentials...');
  await page.waitForSelector('input[name="session_key"]', { timeout: 10000 });
  
  // Type with random human-like delays between characters
  await page.type('input[name="session_key"]', env_vars['LINKEDIN_EMAIL'], { delay: 100 + Math.random() * 100 });
  await randomDelay(500, 1000);
  
  await page.type('input[name="session_password"]', env_vars['LINKEDIN_PASSWORD'], { delay: 100 + Math.random() * 100 });
  await randomDelay(500, 1000);

  console.log('üîò Clicking login button...');
  await page.click('button[type="submit"]');

  await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 180000 });

  const currentUrl = page.url();
  console.log(`   Current URL after login: ${currentUrl}`);

  // Check for checkpoint/verification
  if (currentUrl.includes('/checkpoint')) {
    throw new Error('LinkedIn requires verification. Please log in manually at https://www.linkedin.com/login and complete the verification, then wait 24 hours before trying again.');
  }

  // Check if login was successful
  if (currentUrl.includes('/login')) {
    throw new Error('Login failed - credentials may be incorrect.');
  }

  console.log('‚úÖ Login successful!');
  await randomDelay(2000, 3000);
}
